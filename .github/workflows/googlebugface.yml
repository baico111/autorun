name: Googleidx Keep Live

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true 

on:
  schedule:
    - cron: '0 * * * *' 
  workflow_dispatch:

jobs:
  dynamic-keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 55 
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Install Tools
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Run Random Loop Session
        env:
          TARGET_URL: "https://nz.117.de5.net/"
          TG_TOKEN: ${{ secrets.TG_TOKEN }} 
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          node -e "
          const { chromium } = require('playwright');
          const exec = require('child_process').execSync;

          function sendToTG(caption, photoPath = null) {
            // ä¸¥æ ¼å¯¹é½ç¯å¢ƒå˜é‡å
            const token = process.env.TG_TOKEN;
            const chatId = process.env.TG_CHAT_ID;
            
            if (!token || !chatId) {
                console.log('è·³è¿‡å‘é€ï¼šTG_TOKEN æˆ– TG_CHAT_ID æœªåœ¨ç¯å¢ƒä¸­æ‰¾åˆ°');
                return;
            }

            try {
              let cmd;
              if (photoPath) {
                cmd = \`curl -s -F \"chat_id=\${chatId}\" -F \"photo=@\${photoPath}\" -F \"caption=\${caption}\" https://api.telegram.org/bot\${token}/sendPhoto\`;
              } else {
                cmd = \`curl -s -d \"chat_id=\${chatId}\" -d \"text=\${caption}\" https://api.telegram.org/bot\${token}/sendMessage\`;
              }
              const response = exec(cmd).toString();
              console.log('TG API å“åº”:', response);
            } catch (e) { 
              console.log('TGå‘é€æŒ‡ä»¤æ‰§è¡Œå¤±è´¥: ' + e.message); 
            }
          }

          (async () => {
            const targetUrl = process.env.TARGET_URL;
            
            // 1. éšæœºå¯åŠ¨å»¶è¿Ÿ (0-10åˆ†é’Ÿ)
            const initialDelay = Math.floor(Math.random() * 10 * 60 * 1000);
            console.log('éšæœºå¯åŠ¨å»¶è¿Ÿ: ' + (initialDelay/60000).toFixed(1) + ' åˆ†é’Ÿ');
            await new Promise(r => setTimeout(r, initialDelay));

            const browser = await chromium.launch({ args: ['--disable-dev-shm-usage'] });
            const context = await browser.newContext({
              viewport: { width: 1280, height: 1200 },
              locale: 'zh-CN',
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36'
            });
            const page = await context.newPage();

            try {
              console.log('æ­£åœ¨è®¿é—®é¡µé¢...');
              // æ”¾å¼ƒç­‰å¾… networkidleï¼Œæ”¹ä¸º domcontentloaded æé«˜æˆåŠŸç‡
              await page.goto(targetUrl, { waitUntil: 'domcontentloaded', timeout: 60000 });
              
              // å…³é”®ï¼šå“ªå’é¢æ¿éœ€è¦æ—¶é—´åŠ è½½ WebSocket æ•°æ®ï¼Œè¿™é‡Œå¼ºåˆ¶ç­‰ 15 ç§’
              await new Promise(r => setTimeout(r, 15000)); 
              
              await page.screenshot({ path: 'monitor.png', fullPage: true });
              console.log('æˆªå›¾å·²ä¿å­˜');

              // ç”Ÿæˆä¸­å›½æ—¶é—´
              const bjTime = new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString().replace(/T/, ' ').replace(/\\..+/, '');
              const msg = \`ğŸ“Š ç½‘é¡µå·¡æ£€æŠ¥å‘Š\\nâ° æ—¶é—´: \${bjTime} (åŒ—äº¬æ—¶é—´)\\nğŸ”— åœ°å€: \${targetUrl}\`;
              
              console.log('å‡†å¤‡å‘é€ TG...');
              sendToTG(msg, 'monitor.png');

              // éšæœºåˆ·æ–°å¾ªç¯
              console.log('è¿›å…¥å¾ªç¯æ¨¡å¼...');
              for (let i = 0; i < 5; i++) {
                const interval = Math.floor(Math.random() * 60 + 60) * 1000;
                await new Promise(r => setTimeout(r, interval));
                console.log('ç¬¬ ' + (i+1) + ' æ¬¡åˆ·æ–°...');
                await page.reload({ waitUntil: 'domcontentloaded' });
              }
            } catch (err) {
              console.error('è¿è¡Œå¼‚å¸¸:', err.message);
              sendToTG('âš ï¸ ç›‘æ§å¼‚å¸¸æŠ¥: ' + err.message);
            } finally {
              await browser.close();
              console.log('ä»»åŠ¡æµæ‰§è¡Œå®Œæ¯•');
            }
          })();
          "
