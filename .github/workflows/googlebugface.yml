name: Secure Random Monitor V3

# æ ¸å¿ƒï¼šæ–°ä»»åŠ¡å¯åŠ¨æ—¶ï¼Œæ—§ä»»åŠ¡å¿…é¡»ç«‹å³åœæ­¢
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true 

on:
  schedule:
    # è®¾å®šæ¯ 3 å°æ—¶è§¦å‘ä¸€æ¬¡ä½œä¸ºåŸºå‡†
    - cron: '0 */3 * * *'
  workflow_dispatch:

jobs:
  dynamic-keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Tools
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Run Random Loop Session
        env:
          TARGET_URL: ${{ secrets.TARGET_URL }}
          TG_BOT_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          node -e "
          const { chromium } = require('playwright');
          const exec = require('child_process').execSync;

          function sendToTG(caption, photoPath = null) {
            if (!process.env.TG_BOT_TOKEN || !process.env.TG_CHAT_ID) return;
            try {
              let cmd = \`curl -s -F \"chat_id=\${process.env.TG_CHAT_ID}\" \`;
              if (photoPath) {
                cmd += \`-F \"photo=@\${photoPath}\" -F \"caption=\${caption}\" https://api.telegram.org/bot\${process.env.TG_BOT_TOKEN}/sendPhoto\`;
              } else {
                cmd += \`-d \"text=\${caption}\" https://api.telegram.org/bot\${process.env.TG_BOT_TOKEN}/sendMessage\`;
              }
              exec(cmd);
            } catch (e) { console.log('TGå‘é€å¤±è´¥'); }
          }

          (async () => {
            const targetUrl = process.env.TARGET_URL;
            if (!targetUrl || targetUrl.trim() === '') {
               console.error('é”™è¯¯: TARGET_URL æœªåœ¨ Secrets ä¸­é…ç½®ï¼');
               process.exit(1);
            }

            // 1. éšæœºå¯åŠ¨å»¶è¿Ÿ (å®ç° 4 å°æ—¶å·¦å³çš„ä¸å›ºå®šæ•ˆæœ)
            const initialDelay = Math.floor(Math.random() * 60 * 60 * 1000);
            console.log('éšæœºå¯åŠ¨å»¶è¿Ÿ: ' + (initialDelay/60000).toFixed(1) + ' åˆ†é’Ÿ');
            await new Promise(r => setTimeout(r, initialDelay));

            const browser = await chromium.launch({ args: ['--disable-dev-shm-usage'] });
            // åˆ é™¤äº† HF_TOKEN ç›¸å…³çš„ extraHTTPHeaders
            const context = await browser.newContext({
              viewport: { width: 1280, height: 800 },
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36'
            });
            const page = await context.newPage();

            try {
              console.log('æ­£åœ¨è®¿é—®ç›®æ ‡é¡µé¢...');
              await page.goto(targetUrl, { waitUntil: 'networkidle', timeout: 120000 });
              
              // 2. ç™»å½•åé©¬ä¸Šæˆªå›¾å¹¶å‘é€
              await new Promise(r => setTimeout(r, 8000));
              await page.screenshot({ path: 'login.png' });
              
              const bjTime = new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toLocaleString('zh-CN', {timeZone: 'UTC'});
              sendToTG('ğŸ”” éšæœºå·¡æ£€å¯åŠ¨\\nâ° æ—¶é—´: ' + bjTime + '\\nâœ… å·²å®Œæˆåˆå§‹æˆªå›¾', 'login.png');

              // 3. éšæœºåˆ·æ–°å¾ªç¯ (æ¯ 2 åˆ†é’Ÿå·¦å³)
              console.log('è¿›å…¥éšæœºåˆ·æ–°å¾ªç¯...');
              while (true) {
                const randomInterval = Math.floor(Math.random() * (210 - 90 + 1) + 90) * 1000;
                await new Promise(r => setTimeout(r, randomInterval));

                console.log('æ‰§è¡Œéšæœºåˆ·æ–°ï¼Œé—´éš”: ' + (randomInterval/1000).toFixed(0) + ' ç§’');
                await page.reload({ waitUntil: 'domcontentloaded' });
                await page.mouse.wheel(0, Math.floor(Math.random() * 300));
              }
            } catch (err) {
              console.error('è¿è¡Œå‡ºé”™:', err.message);
              sendToTG('âš ï¸ è¿è¡Œå¼‚å¸¸: ' + err.message);
            } finally {
              await browser.close();
            }
          })();
          "
