name: Googleidx Keep Live

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true 

on:
  schedule:
    - cron: '0 * * * *' # å»ºè®®æ”¹ä¸ºæ¯å°æ—¶æ‰§è¡Œï¼Œéšæœºå»¶è¿Ÿç¼©å°ï¼Œé˜²æ­¢å †ç§¯
  workflow_dispatch:

jobs:
  dynamic-keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 55 # GitHub Actions æ¯å°æ—¶ä»»åŠ¡å»ºè®®é™åˆ¶åœ¨ 60 åˆ†é’Ÿå†…
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Chinese Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Install Tools
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium --with-deps

      - name: Run Random Loop Session
        env:
          TARGET_URL: "https://nz.117.de5.net/"
          TG_TOKEN: ${{ secrets.TG_TOKEN }} # ä½¿ç”¨ä½ æŒ‡å®šçš„å˜é‡å
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          node -e "
          const { chromium } = require('playwright');
          const exec = require('child_process').execSync;

          function sendToTG(caption, photoPath = null) {
            if (!process.env.TG_TOKEN || !process.env.TG_CHAT_ID) return;
            try {
              let cmd = \`curl -s -F \"chat_id=\${process.env.TG_CHAT_ID}\" \`;
              if (photoPath) {
                cmd += \`-F \"photo=@\${photoPath}\" -F \"caption=\${caption}\" https://api.telegram.org/bot\${process.env.TG_TOKEN}/sendPhoto\`;
              } else {
                cmd += \`-d \"text=\${caption}\" https://api.telegram.org/bot\${process.env.TG_TOKEN}/sendMessage\`;
              }
              exec(cmd);
            } catch (e) { console.log('TGå‘é€å¤±è´¥'); }
          }

          (async () => {
            const targetUrl = process.env.TARGET_URL;
            
            // 1. éšæœºå¯åŠ¨å»¶è¿Ÿ (ç¼©çŸ­åˆ° 0-10 åˆ†é’Ÿï¼Œé¿å…å ç”¨è¿‡å¤š Action æ—¶é—´å¯¼è‡´è¶…æ—¶)
            const initialDelay = Math.floor(Math.random() * 10 * 60 * 1000);
            console.log('éšæœºå¯åŠ¨å»¶è¿Ÿ: ' + (initialDelay/60000).toFixed(1) + ' åˆ†é’Ÿ');
            await new Promise(r => setTimeout(r, initialDelay));

            const browser = await chromium.launch({ args: ['--disable-dev-shm-usage'] });
            const context = await browser.newContext({
              viewport: { width: 1280, height: 1200 },
              locale: 'zh-CN', // å¼ºåˆ¶ä¸­æ–‡ç¯å¢ƒ
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36'
            });
            const page = await context.newPage();

            try {
              console.log('æ­£åœ¨è®¿é—®ç›®æ ‡é¡µé¢...');
              // å…³é”®ä¿®å¤ï¼šæ”¹ä¸º commit æ¨¡å¼ï¼Œåªè¦é¡µé¢åŸºæœ¬åŠ è½½å°±ç»§ç»­ï¼Œä¸å†æ­»ç­‰æ‰€æœ‰ç½‘ç»œè¯·æ±‚
              await page.goto(targetUrl, { waitUntil: 'domcontentloaded', timeout: 60000 });
              
              // å¼ºåˆ¶ç­‰å¾…é¡µé¢ JS æ¸²æŸ“
              await new Promise(r => setTimeout(r, 10000));
              await page.screenshot({ path: 'monitor.png', fullPage: true });
              
              const bjTime = new Date(new Date().getTime() + 8 * 60 * 60 * 1000).toISOString().replace(/T/, ' ').replace(/\\..+/, '');
              sendToTG('ğŸ“Š ç½‘é¡µè‡ªåŠ¨å·¡æ£€\\nâ° æ—¶é—´: ' + bjTime + ' (åŒ—äº¬æ—¶é—´)\\nğŸ”— ç›®æ ‡: ' + targetUrl, 'monitor.png');

              // 3. éšæœºåˆ·æ–°å¾ªç¯ (ä¿æŒè¿è¡Œä¸€æ®µæ—¶é—´)
              console.log('è¿›å…¥éšæœºåˆ·æ–°å¾ªç¯...');
              let count = 0;
              while (count < 5) { // é™åˆ¶å¾ªç¯æ¬¡æ•°ï¼Œé˜²æ­¢ Action è¿è¡Œè¶…æ—¶è¢«å¼ºåˆ¶æ€æ‰
                const randomInterval = Math.floor(Math.random() * (120 - 60 + 1) + 60) * 1000;
                await new Promise(r => setTimeout(r, randomInterval));
                console.log('æ‰§è¡Œéšæœºåˆ·æ–°ï¼Œé—´éš”: ' + (randomInterval/1000).toFixed(0) + ' ç§’');
                await page.reload({ waitUntil: 'domcontentloaded' });
                count++;
              }
            } catch (err) {
              console.error('è¿è¡Œå‡ºé”™:', err.message);
              sendToTG('âš ï¸ è¿è¡Œå¼‚å¸¸: ' + err.message);
            } finally {
              await browser.close();
              console.log('ä»»åŠ¡ç»“æŸ');
            }
          })();
          "
