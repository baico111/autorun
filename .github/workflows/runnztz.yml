name: Hourly Website Screenshot

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  screenshot-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Chinese Fonts and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk
          python -m pip install --upgrade pip
          # å¢åŠ  pytz ç”¨äºå¤„ç†ä¸­å›½æ—¶åŒº
          pip install playwright pytz
          playwright install chromium

      - name: Capture and Send
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        shell: python
        run: |
          import os
          import subprocess
          from datetime import datetime
          import pytz
          from playwright.sync_api import sync_playwright

          def run():
              # è·å–ç¯å¢ƒå˜é‡
              token = os.environ.get('TG_TOKEN')
              chat_id = os.environ.get('TG_CHAT_ID')
              url = "https://nz.117.de5.net/"
              photo_path = "screenshot.png"

              # è·å–ä¸­å›½æ ‡å‡†æ—¶é—´ (CST)
              tz = pytz.timezone('Asia/Shanghai')
              now_china = datetime.now(tz).strftime('%Y-%m-%d %H:%M:%S')

              with sync_playwright() as p:
                  print(f"[{now_china}] æ­£åœ¨å¯åŠ¨æµè§ˆå™¨è®¿é—®: {url}")
                  browser = p.chromium.launch()
                  context = browser.new_context(locale="zh-CN")
                  page = context.new_page()
                  
                  try:
                      page.goto(url, timeout=60000, wait_until="networkidle")
                      page.wait_for_timeout(5000) 
                      page.screenshot(path=photo_path, full_page=True)
                      
                      # å‘é€è‡³ Telegramï¼ŒCaption åŒ…å«ä¸­å›½æ—¶é—´
                      caption = f"ğŸ“Š ç½‘é¡µç›‘æ§æˆªå›¾\nâ° æ—¶é—´: {now_china} (åŒ—äº¬æ—¶é—´)\nğŸ”— åœ°å€: {url}"
                      
                      cmd = [
                          "curl", "-s", "-X", "POST",
                          f"https://api.telegram.org/bot{token}/sendPhoto",
                          "-F", f"chat_id={chat_id}",
                          "-F", f"photo=@{photo_path}",
                          "-F", f"caption={caption}"
                      ]
                      subprocess.run(cmd, capture_output=True, text=True)
                      print(f"ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ—¶é—´ï¼š{now_china}")
                          
                  except Exception as e:
                      print(f"å‡ºé”™: {e}")
                  finally:
                      browser.close()

          if __name__ == "__main__":
              run()
